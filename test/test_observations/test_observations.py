import json
import unittest

from science.observations.behavioral_analysis import feature_count_phi_df_from_trajectory
from science.agents.actions import Trajectory
from science.observations.text_analysis import FEATURE_PRECISION

import science.observations.observations as obs

UTTERANCE = "good job! pink squares are good, yellow circles are bad."
TEST_PSITURK_GAME_RECORD = json.loads('{"config_name": "clusters_2.2", "name": "full_game_record", "level": 1, "player_locations": [[0, 38, 38], [16.74419999999809, 38, 38], [33.48839999999618, 38, 38], [50.03089999999793, 38, 38], [66.87039999999688, 38, 38], [83.6158999999956, 38, 38], [100.21509999999545, 38, 38], [117.01579999999669, 38, 38], [133.6996999999945, 38, 38], [150.235699999996, 38, 38], [167.07879999999713, 38, 38], [183.77919999999867, 38, 38], [200.43349999999919, 38, 38], [217.0877999999997, 38, 38], [233.78919999999925, 38, 38], [250.3578999999998, 38, 38], [267.18120000000056, 38, 38], [283.8899999999994, 38, 38], [300.4974999999977, 38, 38], [317.2071999999986, 38, 38], [334.22269999999554, 38, 38], [350.7813999999955, 38.125, 37.875], [367.6125999999931, 38.25, 37.75], [384.27279999999155, 38.375, 37.625], [400.93299999999, 38.5, 37.5], [417.59479999998877, 38.625, 37.375], [434.24509999998844, 38.75, 37.25], [450.74799999998646, 38.875, 37.125], [467.5019999999873, 39, 37], [484.15339999998685, 39.125, 36.875], [500.8145999999862, 39.25, 36.75], [517.1634999999864, 39.375, 36.625], [533.8242999999842, 39.5, 36.5], [550.3517999999837, 39.625, 36.375], [567.1156999999832, 39.75, 36.25], [583.8795999999828, 39.875, 36.125], [600.6442999999825, 40, 36], [617.5635999999824, 40.125, 35.875], [634.329299999983, 40.25, 35.75], [650.999599999981, 40.375, 35.625], [667.77169999998, 40.5, 35.5], [684.5454999999783, 40.625, 35.375], [701.3028999999776, 40.75, 35.25], [718.2268999999797, 40.875, 35.125], [735.0018999999796, 41, 35], [751.6739999999816, 41.125, 34.875], [768.3460999999835, 41.25, 34.75], [785.0164999999862, 41.375, 34.625], [801.5324999999865, 41.5, 34.5], [818.3535999999875, 41.625, 34.375], [835.0132999999913, 41.75, 34.25], [851.6739999999932, 41.875, 34.125], [868.3366999999969, 42, 34], [885.0090999999985, 42.125, 33.875], [901.5199999999982, 42.25, 33.75], [918.3365000000019, 42.375, 33.625], [935.0074000000022, 42.5, 33.5], [951.6783000000025, 42.625, 33.375], [968.3508000000002, 42.75, 33.25], [985.0252000000007, 42.875, 33.125], [1001.5458000000012, 43, 33], [1018.3908999999984, 43.125, 32.875], [1035.074999999997, 43.25, 32.75], [1051.761799999996, 43.375, 32.625], [1068.443299999996, 43.5, 32.5], [1085.1294999999955, 43.625, 32.375], [1101.655999999994, 43.75, 32.25], [1118.4892999999925, 43.875, 32.125], [1135.3225999999909, 44, 32], [1152.16289999999, 44.125, 31.875], [1168.9906999999891, 44.25, 31.75], [1185.8328999999883, 44.375, 31.625], [1202.4903999999894, 44.5, 31.5], [1219.4209999999905, 44.625, 31.375], [1236.23979999999, 44.75, 31.25], [1253.2602999999888, 44.875, 31.125], [1270.077399999989, 45, 31], [1286.8971999999865, 45.125, 30.875], [1303.5556999999856, 45.25, 30.75], [1320.2141999999847, 45.375, 30.625], [1336.9847999999852, 45.5, 30.5], [1353.591699999984, 45.625, 30.375], [1370.1738999999825, 45.75, 30.25], [1386.7809999999822, 45.875, 30.125], [1403.2758999999814, 46, 30], [1419.8759999999804, 46.125, 29.875], [1436.2824999999807, 46.25, 29.75], [1452.904399999979, 46.375, 29.625], [1469.5087999999814, 46.5, 29.5], [1486.113999999981, 46.625, 29.375], [1502.7191999999804, 46.75, 29.25], [1519.2038999999784, 46.875, 29.125], [1535.8624999999795, 47, 29], [1552.5239999999785, 47.125, 28.875], [1569.181299999976, 47.25, 28.75], [1585.8398999999743, 47.375, 28.625], [1602.5007999999739, 47.5, 28.5], [1619.1604999999747, 47.625, 28.375], [1635.8039999999744, 47.75, 28.25], [1652.4963999999743, 47.875, 28.125], [1669.1555999999748, 48, 28], [1685.8147999999753, 48.125, 27.875], [1702.431499999977, 48.25, 27.75], [1719.0541999999755, 48.375, 27.625], [1735.6711999999739, 48.5, 27.5], [1752.287499999974, 48.625, 27.375], [1768.9048999999738, 48.75, 27.25], [1785.5229999999722, 48.875, 27.125], [1802.1401999999684, 49, 27], [1818.7568999999671, 49.125, 26.875], [1835.3432999999643, 49.25, 26.75], [1851.9619999999647, 49.375, 26.625], [1868.5806999999652, 49.5, 26.5], [1885.2368999999658, 49.625, 26.375], [1901.888399999967, 49.75, 26.25], [1918.5433999999689, 49.875, 26.125], [1935.2026999999712, 50, 26], [1951.859599999973, 50.125, 25.875], [1968.5156999999745, 50.25, 25.75], [1985.1701999999786, 50.375, 25.625], [2001.8265999999799, 50.5, 25.5], [2018.494699999981, 50.625, 25.375], [2035.149499999982, 50.75, 25.25], [2051.804299999983, 50.875, 25.125], [2068.4538999999813, 51, 25], [2085.0991999999824, 51.125, 24.875], [2101.7459999999846, 51.25, 24.75], [2118.400199999983, 51.375, 24.625], [2135.044899999985, 51.5, 24.5], [2151.6886999999874, 51.625, 24.375], [2168.334399999987, 51.75, 24.25], [2184.9795999999887, 51.875, 24.125], [2201.6123999999895, 52, 24], [2218.2664999999893, 52.125, 23.875], [2234.920599999989, 52.25, 23.75], [2251.5903999999923, 52.375, 23.625], [2268.259199999992, 52.5, 23.5], [2284.924499999991, 52.625, 23.375], [2301.596799999994, 52.75, 23.25], [2318.474499999994, 52.875, 23.125], [2335.316499999992, 53, 23], [2351.9855999999913, 53.125, 22.875], [2368.652999999991, 53.25, 22.75], [2385.3306999999913, 53.375, 22.625], [2401.9997999999932, 53.5, 22.5], [2418.668899999995, 53.625, 22.375], [2435.378399999995, 53.75, 22.25], [2452.0261999999984, 53.875, 22.125], [2468.7327000000014, 54, 22], [2485.3605000000034, 54.125, 21.875], [2501.802000000004, 54.25, 21.75], [2518.2699000000075, 54.375, 21.625], [2534.921200000011, 54.5, 21.5], [2551.5737000000136, 54.625, 21.375], [2568.2054000000176, 54.75, 21.25], [2584.847300000017, 54.875, 21.125], [2601.489200000017, 55, 21], [2618.0879000000164, 55.125, 20.875], [2634.799700000015, 55.25, 20.75], [2651.4206000000154, 55.375, 20.625], [2668.103700000013, 55.5, 20.5], [2684.7654000000125, 55.625, 20.375], [2701.4588000000135, 55.75, 20.25], [2718.1317000000126, 55.875, 20.125], [2734.792800000013, 56, 20], [2751.47620000001, 56, 19.875], [2768.138900000011, 56, 19.75], [2784.8016000000116, 56, 19.625], [2801.4774000000116, 56, 19.5], [2818.091300000011, 56, 19.375], [2834.740400000009, 56, 19.25], [2851.407200000009, 56, 19.125], [2868.0696000000075, 56, 19], [2884.707900000005, 56, 18.875], [2901.3729000000044, 56, 18.75], [2918.0344000000036, 56, 18.625], [2934.6844000000037, 56, 18.5], [2951.3458000000037, 56, 18.375], [2968.0072000000036, 56, 18.25], [2984.6518000000033, 56, 18.125], [3001.301000000003, 56, 18], [3017.9618000000037, 56, 17.875], [3034.595900000002, 56, 17.75], [3051.251900000002, 56, 17.625], [3067.913200000003, 56, 17.5], [3084.558500000004, 56, 17.375], [3101.2214000000026, 56, 17.25], [3117.9280000000017, 56, 17.125], [3134.576900000002, 56, 17], [3151.225800000002, 56, 16.875], [3167.8759000000036, 56, 16.75], [3184.5479000000037, 56, 16.625], [3201.208300000003, 56, 16.5], [3217.8704000000043, 56, 16.375], [3234.521600000006, 56, 16.25], [3251.1719000000057, 56, 16.125], [3267.820600000005, 56, 16], [3284.478400000006, 56, 15.875], [3301.0911000000065, 56, 15.75], [3317.7505000000046, 56, 15.625], [3334.409900000003, 56, 15.5], [3351.0683000000004, 56, 15.375], [3367.9679999999976, 56, 15.25], [3384.623699999998, 56, 15.125], [3401.3412999999955, 56, 15], [3418.059999999993, 56, 14.875], [3434.7359999999912, 56, 14.75], [3451.3961999999897, 56, 14.625], [3468.111299999988, 56, 14.5], [3484.7831999999867, 56, 14.375], [3501.4629999999847, 56, 14.25], [3518.142799999983, 56, 14.125], [3534.8207999999827, 56, 14], [3551.2344999999846, 56, 13.875], [3567.9266999999836, 56, 13.75], [3584.5873999999826, 56, 13.625], [3601.2491999999843, 56, 13.5], [3617.8977999999847, 56, 13.375], [3634.5766999999837, 56, 13.25], [3651.187899999983, 56, 13.125], [3667.840799999984, 56, 13], [3684.4971999999852, 56, 12.875], [3701.1535999999865, 56, 12.75], [3717.8660999999865, 56, 12.625], [3734.5363999999845, 56, 12.5], [3751.2055999999825, 56, 12.375], [3767.8090999999827, 56, 12.25], [3784.5658999999796, 56, 12.125], [3801.2256999999795, 56, 12], [3817.949199999978, 56, 11.875], [3834.597499999979, 56, 11.75], [3851.284099999977, 56, 11.625], [3867.9328999999752, 56, 11.5], [3884.5816999999734, 56, 11.375], [3901.177299999971, 56, 11.25], [3917.8271999999724, 56, 11.125], [3934.443999999973, 56, 11], [3951.1042999999736, 56, 10.875], [3967.6139999999746, 56, 10.75], [3984.2738999999733, 56, 10.625], [4000.9060999999747, 56, 10.5], [4017.576899999973, 56, 10.375], [4034.210599999973, 56, 10.25], [4050.882899999973, 56, 10.125], [4067.5551999999725, 56, 10], [4084.226699999975, 56, 9.875], [4100.905799999975, 56, 9.75], [4117.578999999977, 56, 9.625], [4134.2509999999775, 56, 9.5], [4150.919699999978, 56, 9.375], [4167.592699999978, 56, 9.25], [4184.21619999998, 56, 9.125], [4200.868199999982, 56, 9], [4217.518799999984, 56, 8.875], [4234.169099999987, 56, 8.75], [4250.81939999999, 56, 8.625], [4267.481299999991, 56, 8.5], [4284.135799999993, 56, 8.375], [4300.823399999992, 56, 8.25], [4317.484099999994, 56, 8.125], [4334.1484999999975, 56, 8], [4350.797999999997, 56, 7.875], [4367.447699999997, 56, 7.75], [4384.1176, 56, 7.625], [4400.869599999998, 56, 7.5], [4417.530499999998, 56, 7.375], [4434.191399999998, 56, 7.25], [4450.850899999998, 56, 7.125], [4467.497899999998, 56, 7], [4484.128299999998, 56.125, 6.875], [4500.790899999996, 56.25, 6.75], [4517.449099999996, 56.375, 6.625], [4534.117599999999, 56.5, 6.5], [4550.7896999999975, 56.625, 6.5], [4567.448099999998, 56.75, 6.5], [4584.025999999999, 56.875, 6.5], [4600.709099999999, 57, 6.5], [4617.392199999999, 57.125, 6.5], [4634.0663, 57.25, 6.5], [4650.778900000002, 57.375, 6.5], [4667.442200000002, 57.5, 6.5], [4684.119600000003, 57.625, 6.5], [4700.795100000003, 57.75, 6.5], [4717.470600000003, 57.875, 6.5], [4734.143000000005, 58, 6.5], [4750.843400000003, 58.125, 6.5], [4767.510300000005, 58.25, 6.5], [4784.170800000006, 58.375, 6.5], [4800.831300000007, 58.5, 6.5], [4817.490500000007, 58.625, 6.5], [4834.115800000007, 58.75, 6.5], [4850.77910000001, 58.875, 6.5], [4867.420300000011, 59, 6.5], [4884.092500000012, 59.125, 6.5], [4900.752700000013, 59.25, 6.5], [4917.401500000014, 59.375, 6.5], [4934.044700000017, 59.5, 6.5], [4950.763500000016, 59.625, 6.5], [4967.413500000016, 59.75, 6.5], [4984.063500000016, 59.875, 6.5], [5000.703000000015, 60, 6.5], [5017.348200000014, 60.125, 6.5], [5034.006800000012, 60.25, 6.5], [5050.718300000011, 60.375, 6.5], [5067.34370000001, 60.5, 6.5], [5083.99620000001, 60.625, 6.5], [5100.656700000008, 60.75, 6.5], [5117.296900000005, 60.875, 6.5], [5133.909900000005, 61, 6.5], [5150.618900000005, 61.125, 6.5], [5167.327900000005, 61.25, 6.5], [5183.904800000005, 61.375, 6.5], [5200.470400000004, 61.5, 6.5], [5217.020500000002, 61.625, 6.5], [5233.529500000002, 61.75, 6.5], [5250.096900000002, 61.875, 6.5], [5266.655099999999, 62, 6.5], [5283.217699999998, 62.125, 6.5], [5299.780599999997, 62.25, 6.5], [5316.4046999999955, 62.375, 6.5], [5332.916899999996, 62.5, 6.5], [5349.429099999996, 62.625, 6.5], [5366.067899999996, 62.75, 6.5], [5382.813199999997, 62.875, 6.5], [5399.464199999998, 63, 6.5], [5416.095200000001, 63.125, 6.5], [5432.741600000001, 63.25, 6.5], [5449.422800000005, 63.375, 6.5], [5466.052100000005, 63.5, 6.5], [5482.681000000007, 63.625, 6.5], [5499.233800000009, 63.75, 6.5], [5515.878200000008, 63.875, 6.5], [5532.5226000000075, 64, 6.5], [5549.206900000004, 64.125, 6.5], [5565.778500000002, 64.25, 6.5], [5582.433300000001, 64.375, 6.5], [5599.110699999998, 64.5, 6.5], [5615.779199999995, 64.625, 6.5], [5632.389799999993, 64.75, 6.5], [5649.095399999991, 64.875, 6.5], [5665.772799999989, 65, 6.5], [5682.449099999986, 65.125, 6.5], [5699.1029999999855, 65.25, 6.5], [5715.756899999985, 65.375, 6.5], [5732.398099999986, 65.5, 6.5], [5749.079399999985, 65.625, 6.5], [5765.746399999984, 65.75, 6.5], [5782.400799999983, 65.875, 6.5], [5799.050199999983, 66, 6.5], [5815.746699999983, 66.125, 6.5], [5832.381299999983, 66.25, 6.5], [5849.033199999983, 66.375, 6.5], [5865.698799999981, 66.5, 6.5], [5882.36979999998, 66.625, 6.5], [5899.04079999998, 66.75, 6.5], [5915.6750999999795, 66.875, 6.5], [5932.232799999979, 67, 6.5], [5948.83699999998, 67.125, 6.5], [5965.448099999978, 67.25, 6.5], [5982.037899999977, 67.375, 6.5], [5998.663899999975, 67.5, 6.5], [6015.272299999975, 67.625, 6.5], [6031.864099999975, 67.75, 6.5], [6048.445499999973, 67.875, 6.5], [6065.035099999975, 68, 6.5], [6081.624699999976, 68.125, 6.5], [6098.324599999977, 68.25, 6.5], [6114.985599999979, 68.375, 6.5], [6131.65539999998, 68.5, 6.5], [6148.294999999984, 68.625, 6.5], [6164.954899999985, 68.75, 6.5], [6181.550999999986, 68.875, 6.5], [6198.246299999987, 69, 6.5], [6215.044799999989, 69.125, 6.5], [6231.702999999991, 69.25, 6.5], [6248.354399999991, 69.375, 6.5], [6265.005799999991, 69.5, 6.5], [6281.5743999999895, 69.625, 6.5], [6298.2932999999875, 69.75, 6.5], [6314.984399999987, 69.875, 6.5], [6331.657599999982, 69.75, 6.5], [6348.376199999981, 69.625, 6.5], [6365.115999999979, 69.5, 6.5], [6381.724599999977, 69.375, 6.5], [6398.285899999973, 69.25, 6.5], [6414.945799999971, 69.125, 6.5], [6431.63449999997, 69, 6.5], [6448.323199999969, 68.875, 6.5], [6464.873699999969, 68.75, 6.5], [6481.370299999968, 68.625, 6.5], [6497.920499999966, 68.5, 6.5], [6514.458499999966, 68.375, 6.5], [6530.955699999964, 68.25, 6.5], [6547.538299999964, 68.125, 6.5], [6564.085899999964, 68, 6.5], [6580.6128999999655, 67.875, 6.5], [6597.167699999964, 67.75, 6.5], [6613.702299999963, 67.625, 6.5], [6630.236899999962, 67.5, 6.5], [6646.971099999959, 67.375, 6.5], [6663.621899999959, 67.25, 6.5], [6680.212499999958, 67.125, 6.5], [6696.859599999957, 67, 6.5], [6713.525499999955, 66.875, 6.5], [6730.073299999953, 66.75, 6.5], [6746.806099999951, 66.625, 6.5], [6763.439099999947, 66.5, 6.5], [6780.083599999944, 66.375, 6.625], [6796.765899999942, 66.25, 6.75], [6813.44819999994, 66.125, 6.875], [6830.063899999937, 66, 7], [6846.851299999936, 65.875, 7.125], [6863.556599999934, 65.75, 7.25], [6880.260999999934, 65.75, 7.375], [6896.963199999934, 65.75, 7.5], [6913.661799999934, 65.75, 7.625], [6930.271299999935, 65.75, 7.75], [6947.070699999936, 65.75, 7.875], [6963.775699999937, 65.75, 8], [6980.432599999936, 65.75, 8.125], [6997.0894999999355, 65.75, 8.25], [7013.688999999935, 65.75, 8.375], [7030.196999999934, 65.75, 8.5], [7046.911099999931, 65.75, 8.625], [7063.509499999928, 65.75, 8.75], [7080.088999999926, 65.75, 8.875], [7096.740699999923, 65.75, 9], [7113.345699999922, 65.75, 9.125], [7129.84719999992, 65.75, 9.25], [7146.5612999999175, 65.75, 9.375], [7163.157999999915, 65.75, 9.5], [7179.754699999912, 65.75, 9.625], [7196.480299999908, 65.75, 9.75], [7213.130599999905, 65.75, 9.875], [7229.662599999902, 65.75, 10], [7246.4331999999, 65.75, 10.125], [7263.092099999898, 65.75, 10.25], [7279.691399999897, 65.75, 10.375], [7296.406199999893, 65.75, 10.5], [7313.145499999891, 65.75, 10.625], [7329.686199999889, 65.75, 10.75], [7346.429499999888, 65.75, 10.875], [7363.1727999998875, 65.75, 11], [7379.849899999888, 65.75, 11.125], [7396.63159999989, 65.75, 11.25], [7413.3859999998895, 65.75, 11.375], [7430.01829999989, 65.75, 11.5], [7446.836599999889, 65.75, 11.625], [7463.569599999887, 65.75, 11.75], [7480.239899999888, 65.75, 11.875], [7496.932399999887, 65.75, 12], [7513.837499999885, 65.75, 12.125], [7530.490899999883, 65.75, 12.25], [7547.144299999882, 65.75, 12.375], [7563.709699999879, 65.75, 12.5], [7580.247099999878, 65.75, 12.625], [7596.822999999879, 65.75, 12.75], [7613.394499999879, 65.75, 12.875], [7629.905399999879, 65.75, 13], [7646.5747999998775, 65.75, 13.125], [7663.161899999876, 65.75, 13.25], [7679.712999999876, 65.75, 13.375], [7696.175599999875, 65.75, 13.5], [7712.7513999998755, 65.75, 13.625], [7729.327199999876, 65.75, 13.75], [7746.083399999877, 65.75, 13.875], [7762.738999999878, 65.75, 14], [7779.387299999876, 65.75, 14.125], [7796.0926999998765, 65.75, 14.25], [7812.728099999876, 65.75, 14.375], [7829.290999999877, 65.75, 14.5], [7846.075499999877, 65.75, 14.625], [7862.727399999877, 65.75, 14.75], [7879.325399999878, 65.75, 14.875], [7896.039699999879, 65.75, 15], [7912.753999999881, 65.75, 15.125], [7929.363799999884, 65.75, 15.25], [7946.175499999884, 65.75, 15.375], [7962.892699999886, 65.75, 15.5], [7979.559099999885, 65.75, 15.625], [7996.324999999886, 65.75, 15.75]], "game_events": [{"data": {"object": {"y": 13, "x": 56, "color_value": -8, "cluster_id": 2, "value": 0}, "score": 0}, "name": "object_collected", "ms_elapsed": 3217.8704000000043}, {"data": {"object": {"y": 4, "x": 56, "cluster_id": 2, "value": -10}, "score": -10}, "name": "object_collected", "ms_elapsed": 4417.530499999998}, {"data": {"object": {"y": 7, "x": 64, "cluster_id": 2, "value": 8}, "score": -2}, "name": "object_collected", "ms_elapsed": 5083.99620000001}, {"data": {"object": {"y": 4, "x": 71, "cluster_id": 2, "value": 8}, "score": 6}, "name": "object_collected", "ms_elapsed": 6015.272299999975}, {"data": {"object": {"y": 15, "x": 68, "color_value": 8, "cluster_id": 2, "value": 0}, "score": 6}, "name": "object_collected", "ms_elapsed": 7446.836599999889}], "task_uuid": "A104V8NZIQFN2F:3QXNC7EIPKJQJ3N82RSHKBZIDM909T", "score": 6, "mode": "normal", "value_mask_config": {"communication": "demo", "shape_config": "triangles_zero", "color_config": "m_c_y", "visibility": "partial"}, "phase": "gameplay", "config": {"frame_data": {"player": {"y": 38, "x": 38}, "objects": [{"y": 10, "x": 5, "cluster_id": 1, "value": 2}, {"y": 18, "x": 16, "cluster_id": 1, "value": 1}, {"y": 18, "x": 7, "cluster_id": 1, "value": 2}, {"y": 10, "x": 18, "cluster_id": 1, "value": -5}, {"y": 3, "x": 5, "cluster_id": 1, "value": -5}, {"y": 15, "x": 68, "color_value": 8, "cluster_id": 2, "value": 0}, {"y": 13, "x": 56, "color_value": -8, "cluster_id": 2, "value": 0}, {"y": 4, "x": 71, "cluster_id": 2, "value": 8}, {"y": 4, "x": 56, "cluster_id": 2, "value": -10}, {"y": 7, "x": 64, "cluster_id": 2, "value": 8}, {"y": 70, "x": 61, "cluster_id": 3, "value": 8}, {"y": 56, "x": 70, "cluster_id": 3, "value": 1}, {"y": 57, "x": 63, "cluster_id": 3, "value": 1}, {"y": 63, "x": 70, "cluster_id": 3, "value": -1}, {"y": 70, "x": 71, "cluster_id": 3, "value": -2}, {"y": 58, "x": 11, "cluster_id": 4, "value": 3}, {"y": 61, "x": 4, "cluster_id": 4, "value": 1}, {"y": 71, "x": 10, "color_value": -10, "cluster_id": 4, "value": 0}, {"y": 68, "x": 3, "cluster_id": 4, "value": -10}, {"y": 71, "x": 17, "cluster_id": 4, "value": -8}], "score": 0, "ms_elapsed": 0}, "game_metadata": {"name": "clusters_2.2", "max_cluster_value": 16, "cluster_configs": [{"num_objects": 5, "actual_negative_value": -10, "centroid": [11, 11], "id": 1, "actual_positive_value": 5}, {"num_objects": 5, "actual_negative_value": -10, "centroid": [64, 11], "id": 2, "actual_positive_value": 16}, {"num_objects": 5, "actual_negative_value": -3, "centroid": [64, 64], "id": 3, "actual_positive_value": 10}, {"num_objects": 5, "actual_negative_value": -18, "centroid": [11, 64], "id": 4, "actual_positive_value": 4}], "uuid": "d78729b2-f9bf-4d54-abcd-281f6fb56c15", "player_size": 4, "max_abs_value": 10, "object_padding": 7, "level_number": 1, "min_abs_value": 1, "object_size": 3, "level_duration_seconds": 8, "ratio_negative_to_zero": 0.7, "cluster_width": 20, "grid_size": 75}}, "event": "level_end", "task_configuration": {"communication": "demo", "shape_config": "triangles_zero", "color_config": "m_c_y", "visibility": "partial"}, "level_max_score": 16, "psiturk_log_uuid": "A104V8NZIQFN2F:3QXNC7EIPKJQJ3N82RSHKBZIDM909T", "ts": "1580226331320"}')


class MyTestCase(unittest.TestCase):

    def test_observation_df_from_feedback(self):

        trajectory = Trajectory.from_pilot_exp_psiturk_record(TEST_PSITURK_GAME_RECORD)

        obs_df = obs.observation_df_from_feedback(UTTERANCE, trajectory,
                                                  feature_attribution_func=feature_count_phi_df_from_trajectory)

        # Should recover 11 features
        self.assertEqual(11, len(obs_df))

        # Negative text sentiment on yellow circles
        yellow_triangle_weight = obs_df[obs_df.feature == "yellow|circle"]["mean"].values[0]
        self.assertGreater(0, yellow_triangle_weight, msg="Yellow circle should have negative valence.")

        # Positive on everything else
        non_triangle_valence = obs_df[obs_df.feature != "yellow|circle"]["mean"].values
        self.assertFalse(any([v < 0 for v in non_triangle_valence]), msg="Non-yellow|circle features should be >0.")

        reference_precision = obs_df[obs_df.feature == "pink|square"]["feature_precision"].values[0]
        self.assertEqual(FEATURE_PRECISION, reference_precision, msg="pink|square should have default precision.")

    def test_edge_case_obs_from_feedback(self):

        trajectory = Trajectory.from_pilot_exp_psiturk_record(TEST_PSITURK_GAME_RECORD)

        # Wipe all our actions
        trajectory.actions = trajectory.actions.iloc[0:0]

        obs_df = obs.observation_df_from_feedback(UTTERANCE, trajectory,
                                                  feature_attribution_func=feature_count_phi_df_from_trajectory)
        self.assertEqual(2, len(obs_df), msg="No objects means we should just return feature-based feedback.")

        obs_df = obs.observation_df_from_feedback("good job", trajectory,
                                                  feature_attribution_func=feature_count_phi_df_from_trajectory)
        self.assertIsNone(obs_df, msg="No objects and only behavioral-praise should return None.")

        # Re-load trajectory
        trajectory = Trajectory.from_pilot_exp_psiturk_record(TEST_PSITURK_GAME_RECORD)
        obs_df = obs.observation_df_from_feedback("", trajectory,
                                                  feature_attribution_func=feature_count_phi_df_from_trajectory)
        self.assertIsNone(obs_df, msg="No utterance means we should return None.")

        utterance = "The right cluster is the best."
        obs_df = obs.observation_df_from_feedback(utterance, trajectory)
        self.assertIsNone(obs_df, msg="Unclear cluster reference means we should return None.")


if __name__ == '__main__':
    unittest.main()
